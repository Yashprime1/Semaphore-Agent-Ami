name: Build-Semaphore-Agent-Variants

on:
  workflow_dispatch:
    inputs:
      Region:
        description: "AWS Region"
        required: false
        default: "eu-west-1"
      iam_instance_profile:
        description: "IAM Instance Profile"
        required: false
        default: "System-SharedResources-PackerEc2InstanceIamProfile-sTs5SePHjF83"

jobs:
  build-default-semaphore-agent-ami:
    runs-on: ubuntu-latest
    outputs:
      default_ami_id: ${{ steps.get_ami_id.outputs.ami_id }}
    steps:
      - name: Checkout agent-aws-stack repo
        uses: actions/checkout@v4
        with:
          repository: Yashprime1/agent-aws-stack
          show-progress: 'false'

      - name: Setup packer
        uses: hashicorp/setup-packer@v3.1.0
        with:
          version: 1.8.1

      - name: Build default agent AMI
        id: build_default_ami
        run: |
          make packer.init
          make packer.build.linux INSTALL_ERLANG=false AMI_INSTANCE_TYPE=t2.micro AMI_ARCH=x86_64 AWS_REGION=${{ github.event.inputs.Region || 'eu-west-1' }} AMI_PREFIX=semaphore-agent-${{ github.run_id }} TOOLBOX_VERSION=v1.26.0 | tee packer_output.log
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.BUILD_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.BUILD_AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ github.event.inputs.Region || 'eu-west-1' }}

      - name: Get default AMI ID
        id: get_ami_id
        run: |
          AMI_ID=$(grep -oP 'ami-[a-z0-9]+' packer_output.log | tail -1)
          echo "ami_id=$AMI_ID" >> $GITHUB_OUTPUT

  build-variants:
    needs: build-default-semaphore-agent-ami
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          show-progress: 'false'

      - name: Setup packer
        uses: hashicorp/setup-packer@v3.1.0
        with:
          version: 1.8.1

      - name: Build both agent variants (with-tools, with-tools-ultron)
        id: build_variants
        run: |
          packer init semaphore-agent-ami/packer-semaphore-agent-variant.pkr.hcl
          packer build -var "default_agent_ami=${{ needs.build-default-semaphore-agent-ami.outputs.default_ami_id }}" -var "aws_region=${{ github.event.inputs.Region }}" -var "iam_instance_profile=${{ github.event.inputs.iam_instance_profile }}" semaphore-agent-ami/packer-semaphore-agent-variant.pkr.hcl | tee packer_variants_output.log
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.BUILD_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.BUILD_AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ github.event.inputs.Region }}


      - name: Output AMI IDs 
        run: |
          echo "with-tools AMI: $(grep -A1 'with-tools\.amazon-ebs\.with-tools:' packer_variants_output.log | tail -1 | awk '{print $2}')"
          echo "with-tools-ultron AMI: $(grep -A1 'with-tools-ultron\.amazon-ebs\.with-tools-ultron:' packer_variants_output.log | tail -1 | awk '{print $2}')"
